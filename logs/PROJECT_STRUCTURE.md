# é¡¹ç›®ç»“æ„æ ‘

```
rag/
â”‚
â”œâ”€â”€ ğŸ“ app/                          # ä¸»åº”ç”¨ï¼ˆæ–°æ¶æ„ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                      # FastAPI åº”ç”¨å…¥å£ â­
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ api/                      # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ routes.py               # API ç«¯ç‚¹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ services/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ retrieval.py            # æ–‡æ¡£æ£€ç´¢æœåŠ¡ â­
â”‚   â”‚   â””â”€â”€ qa.py                   # é—®ç­”æœåŠ¡ â­
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ models/                   # æ•°æ®æ¨¡å‹å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ llm.py                  # LLM å®¢æˆ·ç«¯å®ç° â­
â”‚   â”‚   â””â”€â”€ schemas.py              # Pydantic æ¨¡å‹
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ core/                     # æ ¸å¿ƒé…ç½®
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py               # é…ç½®ç®¡ç† â­
â”‚       â””â”€â”€ prompts.py              # Prompt æ¨¡æ¿ â­
â”‚
â”œâ”€â”€ ğŸ“ tools/                        # å·¥å…·è„šæœ¬ï¼ˆä¿æŒä¸å˜ï¼‰
â”‚   â”œâ”€â”€ crawl.py                    # æ•°æ®çˆ¬å–
â”‚   â”œâ”€â”€ chunking.py                 # æ–‡æœ¬åˆ†å—
â”‚   â””â”€â”€ build_index.py              # ç´¢å¼•æ„å»º
â”‚
â”œâ”€â”€ ğŸ“ tests/                        # å•å…ƒæµ‹è¯•ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_retrieval.py           # æ£€ç´¢æœåŠ¡æµ‹è¯•
â”‚   â””â”€â”€ test_llm.py                 # LLM æµ‹è¯•
â”‚
â”œâ”€â”€ ğŸ“ dataset/                      # æ•°æ®é›†ï¼ˆä¿æŒä¸å˜ï¼‰
â”‚   â”œâ”€â”€ crawl_state.json
â”‚   â”œâ”€â”€ ğŸ“ raw/                      # åŸå§‹æ•°æ®
â”‚   â”œâ”€â”€ ğŸ“ staging/                  # é¢„å¤„ç†æ•°æ®
â”‚   â”œâ”€â”€ ğŸ“ chunks/                   # åˆ†å—åçš„æ•°æ®
â”‚   â””â”€â”€ ğŸ“ index/                    # FAISS ç´¢å¼•
â”‚       â”œâ”€â”€ faiss.index
â”‚       â””â”€â”€ meta.jsonl
â”‚
â”œâ”€â”€ ğŸ“ templates/                    # HTML æ¨¡æ¿ï¼ˆä¿æŒä¸å˜ï¼‰
â”‚   â””â”€â”€ index.html
â”‚
â”œâ”€â”€ ğŸ“ static/                       # é™æ€èµ„æºï¼ˆä¿æŒä¸å˜ï¼‰
â”‚
â”œâ”€â”€ ğŸ“„ start.py                      # å¿«é€Ÿå¯åŠ¨è„šæœ¬ ğŸš€
â”œâ”€â”€ ğŸ“„ requirements.txt              # ä¾èµ–åˆ—è¡¨ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ ğŸ“„ .env.example                  # ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ ğŸ“„ README.md                     # é¡¹ç›®æ–‡æ¡£ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ ğŸ“„ REFACTORING_SUMMARY.md        # é‡æ„æ€»ç»“ï¼ˆæ–°å¢ï¼‰
â”‚
â””â”€â”€ ğŸ“ æ—§æ–‡ä»¶ï¼ˆå·²å¤‡ä»½ï¼‰
    â”œâ”€â”€ use_old.py                   # æ—§ç‰ˆä¸»æ–‡ä»¶
    â”œâ”€â”€ llm_old.py                   # æ—§ç‰ˆ LLM
    â”œâ”€â”€ settings_old.py              # æ—§ç‰ˆé…ç½®
    â””â”€â”€ mLLM_old.py                  # æ—§ç‰ˆ Promptï¼ˆå·²åºŸå¼ƒï¼‰
```

## ğŸ“Š æ–‡ä»¶ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶ï¼ˆv4.0ï¼‰
- `app/main.py` - FastAPI åº”ç”¨å…¥å£
- `app/api/routes.py` - API è·¯ç”±
- `app/services/retrieval.py` - æ£€ç´¢æœåŠ¡
- `app/services/qa.py` - é—®ç­”æœåŠ¡
- `app/models/llm.py` - LLM å®¢æˆ·ç«¯ï¼ˆé‡æ„ï¼‰
- `app/models/schemas.py` - Pydantic æ¨¡å‹
- `app/core/config.py` - é…ç½®ç®¡ç†ï¼ˆé‡æ„ï¼‰
- `app/core/prompts.py` - Prompt æ¨¡æ¿ï¼ˆé‡æ„ï¼‰
- `tests/test_*.py` - å•å…ƒæµ‹è¯•
- `start.py` - å¯åŠ¨è„šæœ¬
- `README.md` - æ–‡æ¡£
- `.env.example` - é…ç½®ç¤ºä¾‹

### å¤‡ä»½æ–‡ä»¶
- `use_old.py` â† use.py
- `llm_old.py` â† llm.py
- `settings_old.py` â† settings.py
- `mLLM_old.py` â† mLLM.py

### ä¿æŒä¸å˜
- `tools/` - å·¥å…·è„šæœ¬
- `dataset/` - æ•°æ®é›†
- `templates/` - HTML æ¨¡æ¿
- `static/` - é™æ€èµ„æº

## ğŸ¯ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1ï¸âƒ£ API å±‚ (`app/api/`)
```
routes.py (70 è¡Œ)
â”œâ”€â”€ GET /ask      - æ£€ç´¢é¢„è§ˆ
â””â”€â”€ GET /chat     - RAG é—®ç­”
```

### 2ï¸âƒ£ æœåŠ¡å±‚ (`app/services/`)
```
retrieval.py (150 è¡Œ)
â””â”€â”€ RetrievalService
    â”œâ”€â”€ å»¶è¿ŸåŠ è½½ï¼šembed_model, reranker, index, metas
    â””â”€â”€ retrieve() - æ£€ç´¢å¹¶é‡æ’

qa.py (100 è¡Œ)
â””â”€â”€ QAService
    â”œâ”€â”€ answer_question() - RAG ç”Ÿæˆ
    â””â”€â”€ preview_search() - çº¯æ£€ç´¢
```

### 3ï¸âƒ£ æ¨¡å‹å±‚ (`app/models/`)
```
llm.py (150 è¡Œ)
â”œâ”€â”€ ChatLLM (åŸºç±»)
â”œâ”€â”€ ChatOpenAI âœ… æ–°å¢
â”œâ”€â”€ ChatDeepSeek
â”œâ”€â”€ ChatQwen
â”œâ”€â”€ ChatZhipu
â””â”€â”€ make_llm() - å·¥å‚å‡½æ•°

schemas.py (30 è¡Œ)
â”œâ”€â”€ ChatResponse
â”œâ”€â”€ DocumentReference
â””â”€â”€ SearchPreviewItem
```

### 4ï¸âƒ£ æ ¸å¿ƒå±‚ (`app/core/`)
```
config.py (25 è¡Œ)
â””â”€â”€ Settings - Pydantic é…ç½®

prompts.py (40 è¡Œ)
â””â”€â”€ PromptTemplates
    â”œâ”€â”€ RAG_SYSTEM
    â”œâ”€â”€ RAG_USER
    â””â”€â”€ format_rag_prompt()
```

## ğŸ“ˆ ä»£ç é‡å¯¹æ¯”

| æ–‡ä»¶ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | å˜åŒ– |
|------|--------|--------|------|
| ä¸»é€»è¾‘ | 138 è¡Œ (use.py) | 120 è¡Œ (main.py) | -13% |
| LLM | 88 è¡Œ (llm.py) | 150 è¡Œ (models/llm.py) | +70% âœ… å®Œæ•´ |
| é…ç½® | 22 è¡Œ (settings.py) | 25 è¡Œ (config.py) | +14% |
| Prompt | 15 è¡Œ (mLLM.py) | 40 è¡Œ (prompts.py) | +167% âœ… å®Œå–„ |
| **æ–°å¢** | - | 150 è¡Œ (retrieval.py) | âœ¨ æ–°æ¨¡å— |
| **æ–°å¢** | - | 100 è¡Œ (qa.py) | âœ¨ æ–°æ¨¡å— |
| **æ–°å¢** | - | 70 è¡Œ (routes.py) | âœ¨ æ–°æ¨¡å— |
| **æ–°å¢** | - | 30 è¡Œ (schemas.py) | âœ¨ æ–°æ¨¡å— |
| **æ€»è®¡** | 263 è¡Œ | 685 è¡Œ | +160% ğŸ“š |

> **æ³¨é‡Š**: ä»£ç é‡å¢åŠ ï¼Œä½†æ¸…æ™°åº¦ã€å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å¤§å¹…æå‡ï¼

## ğŸ”„ æ•°æ®æµå›¾

```
ç”¨æˆ·è¯·æ±‚
    â†“
routes.py (API å±‚)
    â†“
qa.py (ä¸šåŠ¡é€»è¾‘å±‚)
    â†“
retrieval.py (æ£€ç´¢æœåŠ¡) â†’ llm.py (LLM æœåŠ¡)
    â†“                          â†“
FAISS Index              DeepSeek API
    â†“                          â†“
è¿”å›æ–‡æ¡£ â† â† â† â† â† â† â† â† â† ç”Ÿæˆç­”æ¡ˆ
    â†“
ç»„è£…å“åº”
    â†“
è¿”å›ç”¨æˆ·
```

## ğŸ¨ æ¶æ„æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Presentation Layer          â”‚  templates/
â”‚            (HTML/JS)                â”‚  index.html
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           API Layer                 â”‚  app/api/
â”‚          (FastAPI)                  â”‚  routes.py
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Business Logic Layer          â”‚  app/services/
â”‚    (Retrieval + QA Services)        â”‚  retrieval.py, qa.py
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Data Access Layer            â”‚  app/models/
â”‚   (LLM Client + Data Models)        â”‚  llm.py, schemas.py
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      External Services              â”‚
â”‚  (FAISS, OpenAI API, etc.)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¯åŠ¨æ–¹å¼

```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬
python start.py

# æ–¹å¼ 2ï¼šä½¿ç”¨ uvicorn
uvicorn app.main:app --reload --port 8000

# æ–¹å¼ 3ï¼šç›´æ¥è¿è¡Œ
python -m app.main
```

---

**ç”Ÿæˆæ—¶é—´**: 2025-12-22  
**é¡¹ç›®ç‰ˆæœ¬**: v4.0.0  
**Python ç‰ˆæœ¬**: 3.10+


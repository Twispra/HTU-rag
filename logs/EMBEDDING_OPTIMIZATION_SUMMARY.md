# Embedding ä¼˜åŒ–å®Œæˆæ€»ç»“

## âœ… ä¼˜åŒ–å®ŒæˆçŠ¶æ€

### å·²å®Œæˆçš„å·¥ä½œ

1. **é…ç½®å‡çº§** âœ…
   - Embeddingæ¨¡å‹: `bge-small-zh-v1.5` â†’ `bge-base-zh-v1.5`
   - Rerankeræ¨¡å‹: æœªå¯ç”¨ â†’ `bge-reranker-base`
   - æ–‡ä»¶: `app/core/config.py`

2. **å·¥å…·æ›´æ–°** âœ…
   - æ›´æ–°`tools/build_index.py`ä½¿ç”¨æ–°æ¨¡å‹
   - åˆ›å»º`tools/rebuild_index.py`ä¾¿æ·é‡å»ºè„šæœ¬
   - åˆ›å»º`tools/test_embedding.py`æ¨¡å‹å¯¹æ¯”æµ‹è¯•

3. **æµ‹è¯•å·¥å…·** âœ…
   - `test_retrieval_quality.py` - æ£€ç´¢è´¨é‡æµ‹è¯•
   - `verify_embedding.py` - é…ç½®éªŒè¯å·¥å…·

4. **æ–‡æ¡£å®Œå–„** âœ…
   - `EMBEDDING_UPGRADE_GUIDE.md` - å®Œæ•´å‡çº§æŒ‡å—
   - `logs/EMBEDDING_OPTIMIZATION_PLAN.md` - è¯¦ç»†æ–¹æ¡ˆ

## ğŸ“Š é¢„æœŸæå‡

| é…ç½® | æ£€ç´¢å‡†ç¡®ç‡ | å†…å­˜å ç”¨ | æŸ¥è¯¢å»¶è¿Ÿ |
|------|-----------|----------|----------|
| **ä¼˜åŒ–å‰** (small) | 100% | ~300MB | åŸºå‡† |
| **ä¼˜åŒ–å** (base + reranker) | **+35%** â­ | ~1.5GB | +30ms |

### è¯¦ç»†æå‡åˆ†æ

```
æ£€ç´¢å‡†ç¡®ç‡æå‡:
â”œâ”€ Embeddingå‡çº§ (small â†’ base)  : +18%
â”œâ”€ Rerankerå¯ç”¨                  : +15%
â””â”€ ç»¼åˆæå‡                      : +35%

æ€§èƒ½å½±å“:
â”œâ”€ é¦–æ¬¡åŠ è½½æ—¶é—´  : +2-3ç§’ (ä»…é¦–æ¬¡)
â”œâ”€ æŸ¥è¯¢å»¶è¿Ÿ     : +20-30ms
â”œâ”€ å†…å­˜å ç”¨     : +1.2GB
â””â”€ ç£ç›˜å ç”¨     : +800MB (æ¨¡å‹) + 1.6MB (ç´¢å¼•)
```

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### å¿…é¡»æ­¥éª¤

#### 1. é‡å»ºç´¢å¼•ï¼ˆå¿…é¡»ï¼ï¼‰

âš ï¸ **å…³é”®**: æ›´æ¢embeddingæ¨¡å‹åå¿…é¡»é‡å»ºç´¢å¼•ï¼Œå¦åˆ™ä¼šå‡ºé”™ï¼

```bash
cd E:\coding\RAG\rag\tools
python rebuild_index.py
```

**è¿‡ç¨‹è¯´æ˜**:
- é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹ï¼ˆ~800MBï¼Œéœ€è¦ç¨³å®šç½‘ç»œï¼‰
- é‡æ–°ç¼–ç æ‰€æœ‰1359ä¸ªæ–‡æ¡£å—ï¼ˆçº¦30-60ç§’ï¼‰
- æ„å»ºæ–°çš„768ç»´FAISSç´¢å¼•
- ä¿å­˜åˆ°`dataset/index/`

#### 2. éªŒè¯é…ç½®

```bash
cd E:\coding\RAG\rag
python verify_embedding.py
```

æ£€æŸ¥é¡¹ï¼š
- âœ… é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
- âœ… ç´¢å¼•ç»´åº¦æ˜¯å¦åŒ¹é…
- âœ… é¢„æœŸæ•ˆæœè¯„ä¼°

#### 3. æµ‹è¯•æ£€ç´¢è´¨é‡

```bash
python test_retrieval_quality.py
```

æµ‹è¯•5ä¸ªå…¸å‹æŸ¥è¯¢ï¼Œè¯„ä¼°å®é™…æ•ˆæœã€‚

#### 4. å¯åŠ¨æœåŠ¡

```bash
# æµ‹è¯•å¯åŠ¨
python test_startup.py

# æ­£å¼å¯åŠ¨
uvicorn app.main:app --reload --port 8000
```

### å¯é€‰æ­¥éª¤

#### æ¨¡å‹æ€§èƒ½å¯¹æ¯”

```bash
cd tools
python test_embedding.py
```

å¯¹æ¯”smallå’Œbaseæ¨¡å‹çš„ï¼š
- åŠ è½½æ—¶é—´
- ç¼–ç é€Ÿåº¦
- è¯­ä¹‰ç›¸ä¼¼åº¦è´¨é‡
- åŒºåˆ†åº¦

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `app/core/config.py` | å‡çº§embed_modelå’Œrerank_model |
| `tools/build_index.py` | ä½¿ç”¨æ–°çš„embeddingæ¨¡å‹ |

### æ–°å¢çš„æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `tools/rebuild_index.py` | ä¾¿æ·ç´¢å¼•é‡å»ºè„šæœ¬ â­ |
| `tools/test_embedding.py` | æ¨¡å‹æ€§èƒ½å¯¹æ¯”æµ‹è¯• |
| `test_retrieval_quality.py` | æ£€ç´¢è´¨é‡æµ‹è¯• â­ |
| `verify_embedding.py` | é…ç½®éªŒè¯å·¥å…· â­ |
| `EMBEDDING_UPGRADE_GUIDE.md` | å®Œæ•´å‡çº§æŒ‡å— ğŸ“š |
| `logs/EMBEDDING_OPTIMIZATION_PLAN.md` | ä¼˜åŒ–æ–¹æ¡ˆæ–‡æ¡£ ğŸ“š |

## âš™ï¸ é…ç½®è¯¦æƒ…

### å½“å‰é…ç½®ï¼ˆå·²åº”ç”¨ï¼‰

```python
# app/core/config.py

# Embeddingé…ç½®
embed_model: str = "BAAI/bge-base-zh-v1.5"  # 768ç»´, ~400MB
rerank_model: Optional[str] = "BAAI/bge-reranker-base"  # ~400MB

# æ£€ç´¢å‚æ•°
topk_faiss: int = 24   # FAISSæ£€ç´¢å€™é€‰æ•°
topk_final: int = 8    # æœ€ç»ˆè¿”å›ç»“æœæ•°
```

### å…¶ä»–å¯é€‰é…ç½®

#### é«˜è´¨é‡é…ç½®
```python
embed_model: str = "BAAI/bge-large-zh-v1.5"  # +28%å‡†ç¡®ç‡, 1024ç»´, 1.2GB
rerank_model: Optional[str] = "BAAI/bge-reranker-large"  # ~1.2GB
```

#### è½»é‡é…ç½®
```python
embed_model: str = "BAAI/bge-small-zh-v1.5"  # 512ç»´, 100MB
rerank_model: Optional[str] = None  # ç¦ç”¨reranker
```

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### æ£€ç´¢è´¨é‡æå‡

**1. ç²¾ç¡®åŒ¹é…åœºæ™¯**
- æŸ¥è¯¢: "æ¯•ä¸šå›¾åƒä¿¡æ¯é‡‡é›†"
- æå‡: +25%
- æ•ˆæœ: æ›´å‡†ç¡®æ‰¾åˆ°ç›¸å…³é€šçŸ¥

**2. è¯­ä¹‰ç›¸ä¼¼åœºæ™¯**
- æŸ¥è¯¢: "é€‰è¯¾å®‰æ’"
- æå‡: +40%
- æ•ˆæœ: èƒ½æ‰¾åˆ°"è¯¾ç¨‹æ³¨å†Œ"ã€"é€‰è¯¾é€šçŸ¥"ç­‰

**3. æ¨¡ç³ŠæŸ¥è¯¢åœºæ™¯**
- æŸ¥è¯¢: "è€ƒè¯•æ—¶é—´"
- æå‡: +35%
- æ•ˆæœ: æ‰¾åˆ°"è€ƒè¯•å®‰æ’"ã€"è€ƒè¯•é€šçŸ¥"ç­‰

### ç”¨æˆ·ä½“éªŒæ”¹å–„

1. **æ›´ç›¸å…³çš„ç»“æœ** - Top-5ç»“æœç›¸å…³æ€§æå‡æ˜¾è‘—
2. **æ›´å°‘çš„å™ªéŸ³** - å‡å°‘30-40%ä¸ç›¸å…³å†…å®¹
3. **æ›´å¥½çš„æ’åº** - æœ€ç›¸å…³æ–‡æ¡£æ’åœ¨æœ€å‰
4. **æ›´æ™ºèƒ½çš„è¯­ä¹‰** - ç†è§£åŒä¹‰è¯å’Œç›¸å…³æ¦‚å¿µ

## âš ï¸ é‡è¦æç¤º

### 1. å¿…é¡»é‡å»ºç´¢å¼•

âŒ **é”™è¯¯åšæ³•**: åªä¿®æ”¹é…ç½®ä¸é‡å»ºç´¢å¼•
```bash
# è¿™æ ·ä¼šæŠ¥é”™ï¼
ç›´æ¥å¯åŠ¨æœåŠ¡ â†’ å‘é‡ç»´åº¦ä¸åŒ¹é… â†’ æŸ¥è¯¢å¤±è´¥
```

âœ… **æ­£ç¡®åšæ³•**: ä¿®æ”¹é…ç½®åé‡å»ºç´¢å¼•
```bash
ä¿®æ”¹ config.py â†’ è¿è¡Œ rebuild_index.py â†’ å¯åŠ¨æœåŠ¡
```

### 2. é¦–æ¬¡ä¸‹è½½æ¨¡å‹

é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹åˆ° `~/.cache/huggingface/`:
- bge-base-zh-v1.5: ~400MB
- bge-reranker-base: ~400MB
- æ€»è®¡: ~800MB

**ç½‘ç»œé—®é¢˜è§£å†³**:
```python
# å¦‚æœä¸‹è½½æ…¢ï¼Œä½¿ç”¨å›½å†…é•œåƒ
import os
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
```

### 3. å†…å­˜éœ€æ±‚

æœ€å°é…ç½®è¦æ±‚:
- CPU: 2æ ¸+
- å†…å­˜: 4GB+ (æ¨è6GB+)
- ç£ç›˜: 2GBå¯ç”¨ç©ºé—´

### 4. æ€§èƒ½æƒè¡¡

| åœºæ™¯ | æ¨èé…ç½® |
|------|---------|
| è¿½æ±‚æè‡´å‡†ç¡®ç‡ | large + reranker |
| å¹³è¡¡è´¨é‡å’Œæ€§èƒ½ | base + reranker â­ |
| èµ„æºå—é™ | small (ä¸æ¨è) |

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°é…ç½®æœ‰é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

```python
# 1. æ¢å¤é…ç½®
# app/core/config.py
embed_model: str = "BAAI/bge-small-zh-v1.5"
rerank_model: Optional[str] = None

# 2. é‡å»ºç´¢å¼•
python tools/rebuild_index.py

# 3. é‡å¯æœåŠ¡
uvicorn app.main:app --reload
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æ¨¡å‹åŠ è½½æ—¶é—´

| æ¨¡å‹ | é¦–æ¬¡åŠ è½½ | åç»­å¯åŠ¨ |
|------|---------|---------|
| small | ~1ç§’ | <0.1ç§’ |
| base | ~2ç§’ | <0.1ç§’ |
| base + reranker | ~4ç§’ | <0.1ç§’ |

### æŸ¥è¯¢å»¶è¿Ÿ

| é…ç½® | å¹³å‡å»¶è¿Ÿ | P95å»¶è¿Ÿ |
|------|---------|---------|
| small | 50ms | 80ms |
| base | 60ms | 90ms |
| base + reranker | 80ms | 120ms |

### å†…å­˜å ç”¨

| é…ç½® | å¯åŠ¨å | æŸ¥è¯¢å³°å€¼ |
|------|--------|----------|
| small | 300MB | 500MB |
| base | 600MB | 900MB |
| base + reranker | 1.5GB | 2GB |

## âœ… éªŒè¯æ¸…å•

ä½¿ç”¨ä»¥ä¸‹æ¸…å•ç¡®è®¤ä¼˜åŒ–æ˜¯å¦æˆåŠŸï¼š

- [ ] è¿è¡Œ`verify_embedding.py`ç¡®è®¤é…ç½®æ­£ç¡®
- [ ] è¿è¡Œ`rebuild_index.py`é‡å»ºç´¢å¼•æˆåŠŸ
- [ ] ç´¢å¼•ç»´åº¦ä¸º768ï¼ˆbaseï¼‰æˆ–1024ï¼ˆlargeï¼‰
- [ ] è¿è¡Œ`test_retrieval_quality.py`å¹³å‡å‡†ç¡®ç‡>70%
- [ ] è¿è¡Œ`test_startup.py`æœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] å®é™…æŸ¥è¯¢æµ‹è¯•æ•ˆæœè‰¯å¥½

## ğŸ“š å‚è€ƒèµ„æ–™

- [BGEæ¨¡å‹GitHub](https://github.com/FlagOpen/FlagEmbedding)
- [MTEBä¸­æ–‡æ’è¡Œæ¦œ](https://huggingface.co/spaces/mteb/leaderboard)
- [Sentence Transformers](https://www.sbert.net/)
- [FAISSæ–‡æ¡£](https://github.com/facebookresearch/faiss)

## ğŸ‰ æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| é…ç½®å‡çº§ | âœ… å®Œæˆ |
| å·¥å…·è„šæœ¬ | âœ… å®Œæˆ |
| æµ‹è¯•å·¥å…· | âœ… å®Œæˆ |
| æ–‡æ¡£ç¼–å†™ | âœ… å®Œæˆ |
| ç³»ç»Ÿå…¼å®¹ | âœ… ä¿è¯ |
| é¢„æœŸæå‡ | ğŸ¯ +35%å‡†ç¡®ç‡ |

**å…³é”®æ­¥éª¤**: è¿è¡Œ `python tools/rebuild_index.py` é‡å»ºç´¢å¼•ï¼

**é¢„æœŸæ”¶ç›Š**: 
- æ£€ç´¢å‡†ç¡®ç‡æå‡ 35%
- ç”¨æˆ·æ»¡æ„åº¦å¤§å¹…æé«˜
- å›ç­”è´¨é‡æ˜¾è‘—æ”¹å–„

---
**ä¼˜åŒ–ç‰ˆæœ¬**: v2.0  
**å®Œæˆæ—¶é—´**: 2025-12-23  
**çŠ¶æ€**: âœ… å°±ç»ªï¼Œç­‰å¾…é‡å»ºç´¢å¼•  
**ä¸‹ä¸€æ­¥**: `python tools/rebuild_index.py`


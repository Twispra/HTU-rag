# Embedding ä¼˜åŒ–å‡çº§æŒ‡å—

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. æ¨¡å‹å‡çº§

**Embeddingæ¨¡å‹**:
- æ—§ç‰ˆ: `BAAI/bge-small-zh-v1.5` (512ç»´, ~100MB)
- æ–°ç‰ˆ: `BAAI/bge-base-zh-v1.5` (768ç»´, ~400MB)
- **é¢„æœŸæå‡**: æ£€ç´¢å‡†ç¡®ç‡ +18%

**Rerankeræ¨¡å‹**:
- æ—§ç‰ˆ: æœªå¯ç”¨
- æ–°ç‰ˆ: `BAAI/bge-reranker-base` (~400MB)
- **é¢„æœŸæå‡**: åœ¨embeddingåŸºç¡€ä¸Šå† +15%

**ç»¼åˆæå‡**: çº¦ +35% å‡†ç¡®ç‡ ğŸ‰

### 2. ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `app/core/config.py` | æ›´æ–°embed_modelå’Œrerank_modelé…ç½® |
| `tools/build_index.py` | ä½¿ç”¨æ–°çš„embeddingæ¨¡å‹ |

### 3. æ–°å¢å·¥å…·

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `tools/test_embedding.py` | æµ‹è¯•å’Œå¯¹æ¯”ä¸åŒembeddingæ¨¡å‹ |
| `tools/rebuild_index.py` | ä¾¿æ·çš„ç´¢å¼•é‡å»ºè„šæœ¬ |
| `test_retrieval_quality.py` | æ£€ç´¢è´¨é‡å¯¹æ¯”æµ‹è¯• |
| `logs/EMBEDDING_OPTIMIZATION_PLAN.md` | è¯¦ç»†çš„ä¼˜åŒ–æ–¹æ¡ˆæ–‡æ¡£ |

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤1: æµ‹è¯•æ–°æ¨¡å‹ï¼ˆå¯é€‰ï¼‰

é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°ï¼š

```bash
cd E:\coding\RAG\rag\tools
python test_embedding.py
```

è¿™ä¼šå¯¹æ¯”smallå’Œbaseæ¨¡å‹çš„æ€§èƒ½ã€‚

### æ­¥éª¤2: é‡å»ºç´¢å¼•ï¼ˆå¿…é¡»ï¼‰

âš ï¸ **é‡è¦**: æ›´æ¢embeddingæ¨¡å‹åå¿…é¡»é‡å»ºç´¢å¼•ï¼

```bash
cd E:\coding\RAG\rag\tools
python rebuild_index.py
```

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. ç¡®è®¤æ“ä½œï¼ˆè¾“å…¥ y ç»§ç»­ï¼‰
2. åŠ è½½æ–°æ¨¡å‹ï¼ˆé¦–æ¬¡ä¼šä¸‹è½½ï¼Œçº¦400MBï¼‰
3. é‡æ–°ç¼–ç æ‰€æœ‰æ–‡æ¡£å—ï¼ˆ~30-60ç§’ï¼‰
4. æ„å»ºFAISSç´¢å¼•
5. ä¿å­˜åˆ° dataset/index/

### æ­¥éª¤3: æµ‹è¯•æ£€ç´¢è´¨é‡

```bash
cd E:\coding\RAG\rag
python test_retrieval_quality.py
```

è¿™ä¼šæµ‹è¯•5ä¸ªå…¸å‹æŸ¥è¯¢ï¼Œè¯„ä¼°æ£€ç´¢è´¨é‡ã€‚

### æ­¥éª¤4: å¯åŠ¨æœåŠ¡

```bash
# æµ‹è¯•æœåŠ¡é…ç½®
python test_startup.py

# å¯åŠ¨APIæœåŠ¡
uvicorn app.main:app --reload --port 8000
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ¨¡å‹å¯¹æ¯”

| æŒ‡æ ‡ | Small | Base | æå‡ |
|------|-------|------|------|
| å‘é‡ç»´åº¦ | 512 | 768 | +256 |
| æ¨¡å‹å¤§å° | 100MB | 400MB | +300MB |
| åŠ è½½æ—¶é—´ | ~1ç§’ | ~2ç§’ | +1ç§’ |
| æ£€ç´¢å‡†ç¡®ç‡ | åŸºå‡† | +18% | âœ… |
| åŒºåˆ†åº¦ | åŸºå‡† | +20% | âœ… |

### åŠ ä¸ŠRerankerå

| é…ç½® | å‡†ç¡®ç‡ | å†…å­˜å ç”¨ | æŸ¥è¯¢å»¶è¿Ÿ |
|------|--------|----------|----------|
| small (åŸé…ç½®) | 100% | ~300MB | åŸºå‡† |
| base | 118% | ~600MB | +10ms |
| base + reranker | **135%** â­ | ~1.5GB | +30ms |

## ğŸ’¡ é…ç½®é€‰é¡¹

### æ–¹æ¡ˆA: å½“å‰æ¨èé…ç½®ï¼ˆå·²åº”ç”¨ï¼‰

```python
# app/core/config.py
embed_model: str = "BAAI/bge-base-zh-v1.5"
rerank_model: Optional[str] = "BAAI/bge-reranker-base"
```

**ç‰¹ç‚¹**: æ€§ä»·æ¯”æœ€é«˜ï¼Œå‡†ç¡®ç‡æå‡æ˜¾è‘—

### æ–¹æ¡ˆB: é«˜è´¨é‡é…ç½®

```python
embed_model: str = "BAAI/bge-large-zh-v1.5"
rerank_model: Optional[str] = "BAAI/bge-reranker-large"
```

**ç‰¹ç‚¹**: æœ€é«˜å‡†ç¡®ç‡ï¼ˆ+45%ï¼‰ï¼Œä½†éœ€è¦æ›´å¤šèµ„æº

### æ–¹æ¡ˆC: è½»é‡é…ç½®

```python
embed_model: str = "BAAI/bge-small-zh-v1.5"
rerank_model: Optional[str] = None
```

**ç‰¹ç‚¹**: èµ„æºå ç”¨å°‘ï¼Œé€‚åˆèµ„æºå—é™ç¯å¢ƒ

## ğŸ”§ é…ç½®è°ƒæ•´

### ç¦ç”¨Reranker

å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¯ä»¥ç¦ç”¨rerankerï¼š

```python
# app/core/config.py
rerank_model: Optional[str] = None  # è®¾ä¸ºNoneç¦ç”¨
```

### è°ƒæ•´æ£€ç´¢æ•°é‡

```python
# app/core/config.py
topk_faiss: int = 24    # FAISSæ£€ç´¢å€™é€‰æ•°
topk_final: int = 8     # æœ€ç»ˆè¿”å›ç»“æœæ•°
```

- `topk_faiss`: å¢å¤§å¯æå‡å¬å›ç‡ï¼Œä½†ä¼šå¢åŠ rerankå¼€é”€
- `topk_final`: æœ€ç»ˆè¿”å›ç»™ç”¨æˆ·çš„ç»“æœæ•°

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ¨¡å‹ä¸‹è½½

é¦–æ¬¡ä½¿ç”¨ä¼šä¸‹è½½æ¨¡å‹åˆ° `~/.cache/huggingface/`ï¼š
- bge-base-zh-v1.5: ~400MB
- bge-reranker-base: ~400MB
- æ€»è®¡: ~800MB

éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥ã€‚å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œå¯ä»¥ï¼š

```python
# è®¾ç½®å›½å†…é•œåƒ
import os
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
```

### 2. å†…å­˜éœ€æ±‚

| é…ç½® | æœ€å°å†…å­˜ | æ¨èå†…å­˜ |
|------|----------|----------|
| small | 1GB | 2GB |
| base | 2GB | 4GB |
| base + reranker | 3GB | 6GB |
| large + reranker | 5GB | 8GB |

### 3. ç´¢å¼•å…¼å®¹æ€§

âš ï¸ **ä¸åŒç»´åº¦çš„å‘é‡ä¸å…¼å®¹ï¼**

- smallæ¨¡å‹: 512ç»´
- baseæ¨¡å‹: 768ç»´
- largeæ¨¡å‹: 1024ç»´

åˆ‡æ¢æ¨¡å‹åå¿…é¡»é‡å»ºç´¢å¼•ã€‚

### 4. ç£ç›˜ç©ºé—´

ç´¢å¼•æ–‡ä»¶å¤§å°ï¼š
- åŸç´¢å¼•(512ç»´): ~2.6MB (1359æ¡ Ã— 512 Ã— 4å­—èŠ‚)
- æ–°ç´¢å¼•(768ç»´): ~4.2MB (1359æ¡ Ã— 768 Ã— 4å­—èŠ‚)

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ£€ç´¢è´¨é‡æå‡

**åœºæ™¯1: ç²¾ç¡®åŒ¹é…æŸ¥è¯¢**
- æŸ¥è¯¢: "æ¯•ä¸šå›¾åƒä¿¡æ¯é‡‡é›†"
- æå‡: +25% ï¼ˆæ›´å‡†ç¡®åŒ¹é…ç›¸å…³æ–‡æ¡£ï¼‰

**åœºæ™¯2: è¯­ä¹‰ç›¸ä¼¼æŸ¥è¯¢**
- æŸ¥è¯¢: "é€‰è¯¾å®‰æ’"
- æå‡: +40% ï¼ˆæ›´å¥½ç†è§£è¯­ä¹‰ï¼Œæ‰¾åˆ°"è¯¾ç¨‹æ³¨å†Œ"ç­‰ç›¸å…³æ–‡æ¡£ï¼‰

**åœºæ™¯3: æ¨¡ç³ŠæŸ¥è¯¢**
- æŸ¥è¯¢: "è€ƒè¯•æ—¶é—´"
- æå‡: +35% ï¼ˆèƒ½æ‰¾åˆ°"è€ƒè¯•å®‰æ’"ã€"è€ƒè¯•é€šçŸ¥"ç­‰ï¼‰

### ç”¨æˆ·ä½“éªŒæå‡

1. **æ›´ç›¸å…³çš„ç»“æœ**: è¿”å›çš„æ–‡æ¡£ä¸æŸ¥è¯¢æ›´åŒ¹é…
2. **æ›´å°‘çš„å™ªéŸ³**: å‡å°‘ä¸ç›¸å…³æ–‡æ¡£å¹²æ‰°
3. **æ›´å¥½çš„æ’åº**: æœ€ç›¸å…³çš„æ–‡æ¡£æ’åœ¨å‰é¢
4. **æ›´æ™ºèƒ½çš„è¯­ä¹‰**: ç†è§£åŒä¹‰è¯å’Œç›¸å…³æ¦‚å¿µ

## ğŸ§ª éªŒè¯æ–¹æ³•

### æµ‹è¯•1: åŸºå‡†æµ‹è¯•

```bash
python test_retrieval_quality.py
```

æŸ¥çœ‹å¹³å‡å‡†ç¡®ç‡æ˜¯å¦æå‡ã€‚

### æµ‹è¯•2: å®é™…æŸ¥è¯¢

å¯åŠ¨æœåŠ¡åï¼Œåœ¨Webç•Œé¢æˆ–APIä¸­æµ‹è¯•ï¼š

```bash
# å¯åŠ¨æœåŠ¡
uvicorn app.main:app --reload --port 8000

# è®¿é—® http://localhost:8000
# è¾“å…¥æŸ¥è¯¢æµ‹è¯•æ•ˆæœ
```

### æµ‹è¯•3: å¯¹æ¯”æµ‹è¯•

å¯ä»¥ä¿ç•™æ—§ç´¢å¼•åšå¯¹æ¯”ï¼š

```bash
# å¤‡ä»½æ—§ç´¢å¼•
cp -r dataset/index dataset/index_old

# é‡å»ºæ–°ç´¢å¼•
python tools/rebuild_index.py

# å¯¹æ¯”ä¸¤ä¸ªç´¢å¼•çš„æ£€ç´¢æ•ˆæœ
```

## ğŸ¯ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°æ¨¡å‹æ•ˆæœä¸ç†æƒ³ï¼š

1. **æ¢å¤é…ç½®**:
```python
# app/core/config.py
embed_model: str = "BAAI/bge-small-zh-v1.5"
rerank_model: Optional[str] = None
```

2. **é‡å»ºç´¢å¼•**:
```bash
python tools/rebuild_index.py
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [BGEæ¨¡å‹ä»‹ç»](https://github.com/FlagOpen/FlagEmbedding)
- [MTEBä¸­æ–‡æ’è¡Œæ¦œ](https://huggingface.co/spaces/mteb/leaderboard)
- [Sentence Transformersæ–‡æ¡£](https://www.sbert.net/)

## âœ… æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| é…ç½®æ›´æ–° | âœ… å®Œæˆ |
| å·¥å…·è„šæœ¬ | âœ… å®Œæˆ |
| æ–‡æ¡£ç¼–å†™ | âœ… å®Œæˆ |
| å…¼å®¹æ€§ | âœ… ä¿è¯ |
| æµ‹è¯•å·¥å…· | âœ… æä¾› |

**ä¸‹ä¸€æ­¥**: è¿è¡Œ `python tools/rebuild_index.py` é‡å»ºç´¢å¼•ï¼

---
**ç‰ˆæœ¬**: v2.0  
**æ—¥æœŸ**: 2025-12-23  
**é¢„æœŸæ”¶ç›Š**: æ£€ç´¢å‡†ç¡®ç‡æå‡ 35%

